name: PR

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]
    paths:
      - "buf.yaml"
      - "buf.lock"
      - "**.proto"
      - "**/buf.md"
      - "**/README.md"
      - "**/LICENSE"
      - ".github/workflows/pull-request.yml"

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize & run Buf
        uses: bufbuild/buf-action@v1
        with:
          token: ${{ secrets.BUF_TOKEN }}

          # Specify the branch to compare against for breaking change detection.
          # The default for push is to compare to the commit before. We want to
          # compare against the main branch for a GitHub flow style workflow.
          breaking_against: .git#branch=main
          breaking: true
          lint: true
          format: true

      - name: Check for uncommitted changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "::error ::Buf format made changes to the codebase. Please run 'buf format' locally and commit the changes."
            git diff
            exit 1
          fi
