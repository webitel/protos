name: Swagger

on:
  push:
    branches: [ main ]
    paths:
      - "swagger/*.swagger.json"
      - ".github/workflows/swagger-mix.yml"

permissions: { contents: read }
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  merge:
    name: Merge files
    runs-on: ubuntu-latest
    permissions: { contents: write }
    steps:

      # TODO: use the hosted tool cache: @actions/tool-cache
      - name: Download go-swagger
        env:
          SWAGGER_VERSION: "0.32.3"
          OS_ARCH: "linux_amd64"

        run: |
          dir=$(mktemp -d)
          curl -sL "https://github.com/go-swagger/go-swagger/releases/download/v${SWAGGER_VERSION}/swagger_${OS_ARCH}" -o $dir/swagger
          sudo install $dir/swagger /usr/local/bin

      - name: Checkout repository
        uses: actions/checkout@v4

      # TODO: enable `fqn_for_swagger_name` in generating swagger files to skip duplicated definitions
      #       and changes like SearchType -> SearchTypeMixin3
      - name: Merge Swagger files
        run: |
          set +e
          swagger mixin swagger/*.swagger.json --output swagger/api.json
          EXIT_CODE=$?
          set -e
      
          if [ $EXIT_CODE -ne 0 ]; then
            echo "::warning::Swagger mixin finished with exit code $EXIT_CODE. Continuing as planned."
            
            if [ $EXIT_CODE -ne 21 ]; then
              exit $EXIT_CODE
            fi
          fi

      - name: Check for local changes
        id: check-changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "::set-output name=found::true"
            echo "Uncommitted changes found: "
            git status --porcelain
          fi

      - name: Create Github APP token
        uses: webitel/reusable-workflows/actions/create-github-app-token@create-github-app-token-v1.0.1
        if: steps.check-changes.outputs.found == 'true'
        id: app-token
        with:
          app-id: ${{ vars.DELIVERY_BOT_APP_ID }}
          private-key: ${{ secrets.DELIVERY_BOT_APP_PEM }}

      - name: Configure git user
        if: steps.check-changes.outputs.found == 'true'
        run: |
          git config --global user.name '${{ steps.app-token.outputs.user-name }}'
          git config --global user.email '${{ steps.app-token.outputs.user-email }}'
          git config --local --add --bool push.autoSetupRemote true

      - name: Commit changes
        if: steps.check-changes.outputs.found == 'true'
        run: |
          git add swagger/api.json
          git commit -m "chore: merge swagger files"
          git push
