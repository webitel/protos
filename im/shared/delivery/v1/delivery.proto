syntax = "proto3";

package webitel.im.shared.delivery.v1;

import "google/protobuf/any.proto";
import "protoc-gen-openapiv2/options/annotations.proto";
option go_package = "github.com/webitel/im-delivery-service/gen/api/v1;impb";

//------------------------------------------------------------------------------
// CLIENT REQUESTS
//------------------------------------------------------------------------------

// StreamRequest defines the subscription parameters for the event stream.
message StreamRequest {
  /*
   * Reserved for future implementation:
   * 1. repeated EventType allowed_events - Filter for specific event types (MESSAGE, ACK, etc.)
   * 2. PingSettings ping                 - Custom heartbeat intervals.
   * 3. int32 max_in_flight               - Flow control (backpressure) limit.
   * 4. string last_event_id              - Support for stream resumption after reconnect.
   */
}

//------------------------------------------------------------------------------
// SERVER EVENTS (TOP-LEVEL)
//------------------------------------------------------------------------------

// ServerEvent is a container for all types of data sent over the delivery stream.
message ServerEvent {
  // Unique identifier for the event. Used for logging, tracing, and deduplication.
  string id = 1 [
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
      description: "Unique identifier of the streamed event"
    }
  ];

  // Timestamp of event generation (Unix epoch in milliseconds).
  int64 created_at = 2;

  // Relative importance of the event for client-side processing priority.
  EventPriority priority = 3;

  // Payload contains the specific event data.
  oneof payload {
    // Confirmation of successful stream establishment.
    ConnectedEvent connected_event = 4;

    // A new incoming message from a chat/thread.
    NewMessageEvent message_event = 5;

    // Acknowledgement of a previously sent message or processed action.
    AckEvent ack_event = 6;

    // Notification about a stream-level or business-logic error.
    ErrorEvent error_event = 7;

    // Heartbeat signal to maintain connection and detect "half-open" sockets.
    PingEvent ping_event = 8;
  }
}

//------------------------------------------------------------------------------
// EVENT PAYLOAD DETAILS
//------------------------------------------------------------------------------

// ConnectedEvent is the first message sent by the server after the stream is opened.
message ConnectedEvent {
  // Status of the stream initialization.
  bool ok = 1 [
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
      description: "Indicates successful stream initialization"
    }
  ];

  // Unique session/connection ID assigned by the server for this stream.
  string connection_id = 2;

  // Current server version. Useful for feature detection and troubleshooting.
  string server_version = 3;
}

// NewMessageEvent contains a message that needs to be delivered to the client.
message NewMessageEvent {
  // Unique delivery identifier (can be used for client-side idempotency).
  string id = 1;

  // The actual message object with content, metadata, and sender info.
 ThreadMessage  message = 2 [
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
      description: "Message delivered via the stream",
    }
  ];
}

message ThreadMessage {
    string id = 1;
    string thread_id = 2;
    Peer from = 3;
    Peer to = 4;

    int64 created_at = 5;
    int64 updated_at = 6;
    string text = 7;
    MessageType type = 8;
    oneof content {
        Document document = 9;
        Image image = 10;
    }
}

// Represents a peer in the messaging system.
// It can be a user, chat, or channel.
message Peer {
  oneof kind {
    // User identifier [direct thread]
    string user_id    = 1;
    // Chat group Id [group thread]
    string chat_id    = 2;
    // Channel Id [channel thread]
    string channel_id = 3;
    // bot Id [bot thread]
    string bot_id     = 4;
  }
}


enum MessageType {
    // Represents an unspecified or unknown message type.
    UNSPECIFIED_MESSAGE_TYPE = 0;
    // Represents a text message.
    TEXT = 1;
    // Represents a document message.
    DOCUMENT = 2;
    // Represents an image message.
    IMAGE = 3;
}

message Document {
  string id = 1;
  string url = 2;
  string file_name = 3; 
  string mime_type = 4; 
  int64 size_bytes = 5;
  int64 created_at = 6;
  string created_by = 7;
  int64 updated_at = 8;
  string updated_by = 9;
}

message Image {
  string id = 1;
  string url = 2;
  string file_name = 3;
  string mime_type = 4;

  message Thumbnail {
    string url = 1;
  }
  repeated Thumbnail thumbnails = 5;
  int64 created_at = 6;
  string created_by = 7;
  int64 updated_at = 8;
  string updated_by = 9;
}

// AckEvent confirms the status of a specific event or message processing on the server.
message AckEvent {
  // Reference to the original event/message ID being acknowledged.
  string id = 1;

  // Result of the operation (Success, Error, etc.).
  Status status = 2;

  // Additional context for the result (e.g., reason for rejection, quota details).
  repeated google.protobuf.Any details = 3;
}

// ErrorEvent communicates issues that occur during the stream's lifetime.
message ErrorEvent {
  // Machine-readable string constant (e.g., "INTERNAL_ERROR", "AUTH_EXPIRED").
  string code = 1 [
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
      description: "Machine-readable error code"
    }
  ];

  // Human-readable message explaining the error.
  string message = 2 [
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
      description: "Human-readable error message"
    }
  ];

  // Structured error metadata for programmatic handling.
  repeated google.protobuf.Any details = 3 [
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
      description: "Additional structured error details"
    }
  ];
}

// PingEvent is used to verify the connection is still active.
message PingEvent {
  // Optional data that the server might include for RTT (Round Trip Time) calculation.
  string echo = 1 [
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
      description: "Optional ping payload"
    }
  ];
}

//------------------------------------------------------------------------------
// ENUMERATIONS
//------------------------------------------------------------------------------

// Status defines the outcome of an operation or delivery process.
enum Status {
  // Unspecified or unknown state.
  STATUS_UNSPECIFIED = 0;

  // The operation was successful.
  SUCCESS = 1;

  // A transient error occurred; retrying might resolve the issue.
  TEMPORARY_ERROR = 2;

  // A fatal error occurred; do not retry with the same parameters.
  PERMANENT_ERROR = 3;

  // The request violated business logic or validation rules.
  REJECTED = 4;
}

// EventPriority defines how urgently the client should handle the incoming event.
enum EventPriority {
  // Unspecified priority.
  PRIORITY_UNSPECIFIED = 0;

  // Critical events (New messages, Errors).
  HIGH = 1;

  // Standard events (Acknowledgements).
  NORMAL = 2;

  // Background events (Pings, Statistics).
  LOW = 3;
}