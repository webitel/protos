syntax = "proto3";

package webitel.im.service.contact.v1;

import "google/protobuf/struct.proto";
import "buf/validate/validate.proto";
import "google/protobuf/field_mask.proto";

option go_package = "github.com/webitel/im-contact-service/gen/go/api/v1;impb";

message SearchContactRequest {
  int32 page = 1;
  int32 size = 2;
  string q = 3;

  string sort = 4;
  repeated string fields = 5;


  repeated string app_id = 6;
  repeated string iss_id = 7;
  repeated string type = 8;
  repeated string ids = 9;
  repeated string subjects = 10;
  int32 domain_id = 11 [
    (buf.validate.field).required = true,
    (buf.validate.field).int32.gt = 0
  ];
}

message CreateContactRequest {
  // Issuer of the Contact
  string iss_id = 1 [(buf.validate.field).required = true];
  string app_id = 2 [(buf.validate.field).required = true];

  // Type of the Contact
  string type = 3 [(buf.validate.field).required = true];

  // Display name
  string name = 4;
  // Username unique inside issuer
  string username = 5
  [
    (buf.validate.field).string.min_len = 1,
    (buf.validate.field).required = true
  ];
  // Optional metadata
  map<string, string> metadata = 6;
  string subject = 7 [
    (buf.validate.field).string.min_len = 1,
    (buf.validate.field).required = true
  ];

  int32 domain_id = 8 [
    (buf.validate.field).required = true,
    (buf.validate.field).int32.gt = 0
  ];
}

message UpdateContactRequest {
  // Unique internal Contact ID
  string id = 1 [(buf.validate.field).string.uuid = true];

  // Display name
  string name = 2;
  // Username unique inside issuer
  string username = 3 [
    (buf.validate.field).string.min_len = 1,
    (buf.validate.field).required = true
  ];
  // Optional metadata
  map<string, string> metadata = 4;
  string subject = 5 [
    (buf.validate.field).string.min_len = 1
  ];

  int32 domain_id = 6 [
    (buf.validate.field).required = true,
    (buf.validate.field).int32.gt = 0
  ];
}

// PatchContactRequest represents a partial update request for a Contact entity.
// Only fields specified in the field_mask will be updated.
//
// Validation rules:
// - id and domain_id are required to uniquely identify the contact.
// - username must be non-empty when provided.
// - field_mask must reference only mutable fields.
// - metadata max key-value pairs = 50, value min length = 1 and max length = 1024.
message PatchContactRequest {

  // Unique identifier of the contact.
  // Must be a valid UUID.
  string id = 1 [
    (buf.validate.field).string.uuid = true,
    (buf.validate.field).required = true
  ];

  // Human-readable display name of the contact.
  // Optional. If present in field_mask, updates the contact name.
  string name = 2;

  // Unique username of the contact within the domain.
  // Required when included in field_mask.
  // Must be a non-empty string.
  string username = 3[
    (buf.validate.field).string.min_len = 1,
    (buf.validate.field).ignore = IGNORE_IF_ZERO_VALUE
  ];

  // Arbitrary key-value metadata associated with the contact.
  // Keys and values must be UTF-8 encoded strings.
  // Existing metadata keys will be overwritten if present in field_mask.
  map<string, string> metadata = 4 [
    (buf.validate.field).map.max_pairs = 50,
    (buf.validate.field).map.keys.string.min_len = 1,
    (buf.validate.field).map.values.string.max_len = 1024
  ];


  // Subject or short description associated with the contact.
  string subject = 5 [
    (buf.validate.field).string.min_len = 1,
    (buf.validate.field).ignore = IGNORE_IF_ZERO_VALUE
  ];

  // Identifier of the domain to which the contact belongs.
  // Must be a positive integer.
  int32 domain_id = 6 [
    (buf.validate.field).required = true,
    (buf.validate.field).int32.gt = 0
  ];

  // Field mask specifying which fields should be updated.
  // Only fields explicitly listed here will be modified.
  //
  // Supported paths:
  // - "name"
  // - "username"
  // - "metadata"
  // - "subject"
  google.protobuf.FieldMask field_mask = 7[
    (buf.validate.field).required = true
  ];
}


message DeleteContactRequest {
  string id = 1 [(buf.validate.field).string.uuid = true];
  int32 domain_id = 2 [
    (buf.validate.field).required = true,
    (buf.validate.field).int32.gt = 0
  ];
}

message CanSendRequest {
  string from = 1 [(buf.validate.field).string.uuid = true];
  string to = 2 [(buf.validate.field).string.uuid = true];
  int32 domain_id = 3 [
    (buf.validate.field).required = true,
    (buf.validate.field).int32.gt = 0
  ];
}

message CanSendResponse {
  bool can = 1;
}



message ContactList {
  int32 page = 1;
  int32 size = 2;
  bool next = 3;
  repeated Contact contacts = 4;
}



message Contact {
  string id = 1;
  string iss_id = 2;
  string app_id = 3;
  string type = 4;

  string name = 5;
  string username = 6;
  map<string, string> metadata = 7;

  int64 created_at = 8;

  int64 updated_at = 9;
  string subject = 10;

  int32 domain_id = 11 [
    (buf.validate.field).required = true,
    (buf.validate.field).int32.gt = 0
  ];
}



enum UnableSendReason {
  UNDEFINED = 0;
  CONTACT_NOT_FOUND = 1;
}
